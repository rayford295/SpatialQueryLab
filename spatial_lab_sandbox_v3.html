<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>SQL → GeoJSON → Map (Leaflet + Supabase)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />
  <style>
    html, body { height: 100%; margin: 0; font-family: system-ui, Arial; }
    .app { display: grid; grid-template-columns: 420px 1fr; height: 100%; }
    .side { padding: 12px; border-right: 1px solid #eee; overflow: auto; }
    .card { border: 1px solid #eee; border-radius: 10px; padding: 10px; margin-bottom: 10px; }
    label { font-size: 12px; color: #333; display:block; margin: 6px 0 4px; }
    input, textarea { width: 100%; box-sizing: border-box; padding: 8px; border: 1px solid #ddd; border-radius: 8px; font-family: ui-monospace, Consolas, monospace; }
    textarea { min-height: 140px; font-size: 12px; }
    button { padding: 8px 10px; border-radius: 8px; border: 1px solid #ddd; background:#fafafa; cursor:pointer; }
    button:hover { background:#f0f0f0; }
    .muted { color:#666; font-size:12px; }
    .ok { color:#1b5e20; }
    .err { color:#b00020; }
    table { width:100%; border-collapse: collapse; font-size:12px; }
    th,td { border-bottom:1px solid #eee; padding:6px; text-align:left; }
    #map { width: 100%; height: 100%; }
  </style>
</head>
<body>
  <div class="app">
    <div class="side">
      <h2>SQL → GeoJSON → Map</h2>

      <div class="card">
        <h3>1) Supabase</h3>
        <label>Project URL</label>
        <input id="sb-url" placeholder="https://xxxx.supabase.co" value="YOUR_SUPABASE_URL" />
        <label>anon public key</label>
        <input id="sb-key" placeholder="eyJhbGciOiJI..." value="YOUR_SUPABASE_ANON_KEY" />
        <div style="margin-top:8px; display:flex; gap:8px;">
          <button id="btn-connect">Connect</button>
          <span id="conn-status" class="muted">Not connected</span>
        </div>
        <p class="muted" style="margin-top:8px;">
          后端函数：<code>run_student_sql(sql text)</code>（只读、强制 LIMIT、禁写）。
        </p>
      </div>

      <div class="card">
        <h3>2) SQL Editor</h3>
        <p class="muted">点击地图设置 <b>{{lon}}</b>/<b>{{lat}}</b>，然后写一个 <b>SELECT/WITH</b> 查询。若结果含列名 <code>geom</code> 且为 GeoJSON 对象，将会绘制。</p>
<textarea id="sql">
-- 简单测试：
select 1 as test;

-- 示例：最近邻 20 个（需要你的表/视图，并确保 geom 是 geometry）
-- select id, name, type,
--        st_distance(geom::geography, st_setsrid(st_point({{lon}}, {{lat}}),4326)::geography) as dist_m,
--        st_asgeojson(geom)::jsonb as geom
-- from campus_safety
-- order by geom <-> st_setsrid(st_point({{lon}}, {{lat}}),4326)
-- limit 20;
</textarea>
        <div style="display:flex; gap:8px; margin-top:8px;">
          <button id="btn-run">Run SQL</button>
          <button id="btn-clear">Clear</button>
        </div>
        <div id="sql-status" class="muted" style="margin-top:6px;">Ready.</div>
      </div>

      <div class="card">
        <h3>3) Results <span id="row-count" class="muted">0</span></h3>
        <div id="tip" class="muted">点击地图设置查询点。</div>
        <div style="max-height:240px; overflow:auto; margin-top:8px;">
          <table id="tbl"><thead><tr><th>Name</th><th>Type</th><th>Dist(m)</th></tr></thead><tbody></tbody></table>
        </div>
      </div>
    </div>

    <div id="map"></div>
  </div>

  <!-- libs -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>

  <script>
    // --- Leaflet map ---
    const map = L.map('map').setView([30.6188, -96.341], 14.2);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution:'&copy; OpenStreetMap contributors'
    }).addTo(map);

    let clicked = null;
    const clickLayer = L.geoJSON().addTo(map);
    const resultLayer = L.geoJSON(null, {
      pointToLayer: (f, latlng) => L.circleMarker(latlng, { radius: 6 })
    }).addTo(map);

    map.on('click', (e) => {
      clicked = { lon: e.latlng.lng, lat: e.latlng.lat };
      clickLayer.clearLayers();
      clickLayer.addData({type:'Feature', geometry:{type:'Point', coordinates:[clicked.lon, clicked.lat]}, properties:{}});
      document.querySelector('#tip').textContent = `Point: lon=${clicked.lon.toFixed(5)}, lat=${clicked.lat.toFixed(5)}`;
    });

    // --- Supabase client ---
    let sb = null;
    document.querySelector('#btn-connect').onclick = () => {
      const url = document.querySelector('#sb-url').value.trim();
      const key = document.querySelector('#sb-key').value.trim();
      if (!url || !key) return alert('Fill URL and anon key');
      sb = window.supabase.createClient(url, key, { auth: { persistSession: false } });
      document.querySelector('#conn-status').textContent = 'Connected';
      document.querySelector('#sql-status').textContent = 'Ready to run SQL.';
    };

    // --- Helpers ---
    function esc(s){ return (''+s).replace(/[&<>\"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[m])); }
    function clearTable(){
      document.querySelector('#tbl tbody').innerHTML = '';
      document.querySelector('#row-count').textContent = '0';
    }

    // --- Run SQL ---
    document.querySelector('#btn-run').onclick = async () => {
      if (!sb) return alert('Connect Supabase first.');
      let sql = document.querySelector('#sql').value;
      if (clicked){
        sql = sql.replaceAll('{{lon}}', clicked.lon).replaceAll('{{lat}}', clicked.lat);
      } else {
        document.querySelector('#sql-status').innerHTML = '<span class="muted">Tip: 点击地图可用 {{lon}}/{{lat}}</span>';
      }

      // 清空可视化
      resultLayer.clearLayers();
      clearTable();

      try {
        const { data, error } = await sb.rpc('run_student_sql', { sql });
        if (error) throw error;

        const rows = data || [];
        const features = [];

        // 填表 + 收集 GeoJSON
        const tbody = document.querySelector('#tbl tbody');
        rows.forEach(row => {
          const name = row.name ?? row.title ?? '';
          const typ  = row.type ?? row.category ?? '';
          const dist = row.dist_m != null ? Number(row.dist_m).toFixed(1) : '';

          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${esc(name)}</td><td>${esc(typ)}</td><td>${esc(dist)}</td>`;
          tbody.appendChild(tr);

          // 兼容 geom 为对象或字符串的情况
          let g = row.geom;
          if (typeof g === 'string') {
            try { g = JSON.parse(g) } catch(_) {}
          }
          if (g && g.type) {
            features.push({ type:'Feature', geometry:g, properties: row });
          }
        });

        if (features.length){
          resultLayer.addData({ type:'FeatureCollection', features });
          try { map.fitBounds(resultLayer.getBounds(), { padding:[20,20] }) } catch(_){}
        }

        document.querySelector('#row-count').textContent = rows.length;
        document.querySelector('#sql-status').innerHTML =
          `<span class="ok">Query OK.</span> Rows: <b>${rows.length}</b>, Features: <b>${features.length}</b>.`;
      } catch (e) {
        document.querySelector('#sql-status').innerHTML = `<span class="err">Error: ${esc(e.message || e)}</span>`;
      }
    };

    document.querySelector('#btn-clear').onclick = () => {
      resultLayer.clearLayers();
      clearTable();
      document.querySelector('#sql-status').textContent = 'Cleared.';
    };
  </script>
</body>
</html>
